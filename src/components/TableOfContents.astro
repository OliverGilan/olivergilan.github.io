---
interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  headings: Heading[];
}

const { headings } = Astro.props;

// Filter to only h2 and h3, and strip any # symbols from text
const tocHeadings = headings
  .filter((h) => h.depth === 2 || h.depth === 3)
  .map((h) => ({
    ...h,
    text: h.text.replace(/#/g, '').trim(),
  }));
---

{tocHeadings.length > 0 && (
  <>
    {/* Desktop: Notion-style slim sidebar */}
    <nav class="toc-sidebar group hidden md:block fixed right-4 top-1/2 -translate-y-1/2 z-40">
      {/* Collapsed state: thin bars */}
      <div class="flex flex-col gap-1.5 items-end group-hover:opacity-0 transition-opacity duration-150">
        {tocHeadings.map((heading) => (
          <a
            href={`#${heading.slug}`}
            class:list={[
              "toc-indicator block bg-ink/20 hover:bg-accent rounded-full transition-colors",
              heading.depth === 2 ? "w-4 h-1" : "w-2 h-1",
            ]}
            data-slug={heading.slug}
          />
        ))}
      </div>

      {/* Expanded state: full text */}
      <div class="absolute right-0 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 pointer-events-none group-hover:pointer-events-auto transition-opacity duration-150 bg-paper/95 backdrop-blur-sm border border-ink/10 rounded-lg shadow-lg p-3 min-w-max">
        <div class="text-[10px] font-sans uppercase tracking-wider text-ink-light/40 mb-2">
          Contents
        </div>
        <ul class="space-y-1.5 text-sm">
          {tocHeadings.map((heading) => (
            <li>
              <a
                href={`#${heading.slug}`}
                class:list={[
                  "toc-link block text-ink-light/70 hover:text-accent transition-colors duration-150 leading-snug whitespace-nowrap",
                  heading.depth === 3 && "pl-3 text-xs",
                ]}
                data-slug={heading.slug}
              >
                {heading.text}
              </a>
            </li>
          ))}
        </ul>
      </div>
    </nav>

    {/* Mobile: Floating button + drawer */}
    <button
      id="toc-mobile-button"
      class="md:hidden fixed bottom-6 right-6 z-50 w-10 h-10 bg-paper border border-ink/10 rounded-full shadow-lg flex items-center justify-center text-ink-light hover:text-accent hover:border-accent/30 transition-all duration-200"
      aria-label="Table of contents"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zM3.75 12h.007v.008H3.75V12zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm-.375 5.25h.007v.008H3.75v-.008zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
      </svg>
    </button>

    {/* Mobile drawer backdrop */}
    <div
      id="toc-backdrop"
      class="md:hidden fixed inset-0 bg-ink/20 z-50 opacity-0 pointer-events-none transition-opacity duration-200"
    ></div>

    {/* Mobile drawer */}
    <nav
      id="toc-drawer"
      class="md:hidden fixed bottom-0 left-0 right-0 z-50 bg-paper border-t border-ink/10 rounded-t-2xl shadow-xl transform translate-y-full transition-transform duration-300 ease-out max-h-[60vh] overflow-y-auto"
    >
      <div class="p-4">
        <div class="flex items-center justify-between mb-4">
          <span class="text-xs font-sans uppercase tracking-wider text-ink-light/50">
            Contents
          </span>
          <button
            id="toc-close-button"
            class="text-ink-light hover:text-ink transition-colors"
            aria-label="Close table of contents"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <ul class="space-y-3">
          {tocHeadings.map((heading) => (
            <li>
              <a
                href={`#${heading.slug}`}
                class:list={[
                  "toc-link-mobile block text-ink-light/70 hover:text-accent transition-colors duration-150",
                  heading.depth === 3 && "pl-4 text-sm",
                ]}
                data-slug={heading.slug}
              >
                {heading.text}
              </a>
            </li>
          ))}
        </ul>
      </div>
      {/* Drag handle */}
      <div class="absolute top-2 left-1/2 -translate-x-1/2 w-10 h-1 bg-ink/10 rounded-full"></div>
    </nav>
  </>
)}

<script>
  // Mobile drawer toggle
  const mobileButton = document.getElementById('toc-mobile-button');
  const drawer = document.getElementById('toc-drawer');
  const backdrop = document.getElementById('toc-backdrop');
  const closeButton = document.getElementById('toc-close-button');

  function openDrawer() {
    drawer?.classList.remove('translate-y-full');
    backdrop?.classList.remove('opacity-0', 'pointer-events-none');
  }

  function closeDrawer() {
    drawer?.classList.add('translate-y-full');
    backdrop?.classList.add('opacity-0', 'pointer-events-none');
  }

  mobileButton?.addEventListener('click', openDrawer);
  closeButton?.addEventListener('click', closeDrawer);
  backdrop?.addEventListener('click', closeDrawer);

  // Close drawer when clicking a link
  document.querySelectorAll('.toc-link-mobile').forEach((link) => {
    link.addEventListener('click', closeDrawer);
  });

  // Scroll spy for desktop sidebar
  const tocLinks = document.querySelectorAll('.toc-link');
  const tocIndicators = document.querySelectorAll('.toc-indicator');
  const headings = document.querySelectorAll('.prose h2[id], .prose h3[id]');

  function updateActiveLink() {
    let currentId = '';

    headings.forEach((heading) => {
      const rect = heading.getBoundingClientRect();
      if (rect.top <= 120) {
        currentId = heading.getAttribute('id') || '';
      }
    });

    // Update expanded text links
    tocLinks.forEach((link) => {
      const slug = link.getAttribute('data-slug');
      if (slug === currentId) {
        link.classList.remove('text-ink-light/70');
        link.classList.add('text-accent', 'font-medium');
      } else {
        link.classList.add('text-ink-light/70');
        link.classList.remove('text-accent', 'font-medium');
      }
    });

    // Update collapsed indicators
    tocIndicators.forEach((indicator) => {
      const slug = indicator.getAttribute('data-slug');
      if (slug === currentId) {
        indicator.classList.remove('bg-ink/20');
        indicator.classList.add('bg-accent');
      } else {
        indicator.classList.add('bg-ink/20');
        indicator.classList.remove('bg-accent');
      }
    });
  }

  // Throttled scroll handler
  let ticking = false;
  window.addEventListener('scroll', () => {
    if (!ticking) {
      requestAnimationFrame(() => {
        updateActiveLink();
        ticking = false;
      });
      ticking = true;
    }
  });

  // Initial update
  updateActiveLink();
</script>
