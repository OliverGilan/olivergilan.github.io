---
import { getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";

const posts = await getCollection("blog", ({ data }) => 
  import.meta.env.DEV || !!data.date_published
);

// Sort by date descending
const sortedPosts = posts.sort(
  (a, b) => new Date(b.data.date_published ?? new Date()).getTime() - new Date(a.data.date_published ?? new Date()).getTime()
);

// Group by year
const postsByYear = sortedPosts.reduce(
  (acc, post) => {
    const year = new Date(post.data.date_published ?? new Date()).getFullYear();
    if (!acc[year]) acc[year] = [];
    acc[year].push(post);
    return acc;
  },
  {} as Record<number, typeof sortedPosts>
);

const years = Object.keys(postsByYear)
  .map(Number)
  .sort((a, b) => b - a);

const formatDate = (date: Date) => {
  return date.toLocaleDateString("en-US", { month: "short", day: "numeric" });
};
---

<BaseLayout title="Writing" description="Thoughts and essays on software, startups, and life.">
  <div class="not-prose">
    <table class="w-full border-collapse">
      <colgroup>
        <col class="w-24" />
        <col />
      </colgroup>
      <tbody>
        {years.map((year, yearIndex) => (
          <>
            {yearIndex > 0 && (
              <tr>
                <td colspan="2" class="h-6"></td>
              </tr>
            )}
            <tr>
              <td colspan="2" class="pb-4">
                <div class="flex items-center gap-4">
                  <h2 class="text-sm font-sans font-semibold text-ink-light uppercase tracking-widest">{year}</h2>
                  <div class="flex-1 h-px bg-ink/10"></div>
                </div>
              </td>
            </tr>
            {postsByYear[year].map((post) => (
              <tr class="group">
                <td class="py-1.5 pr-4 text-right align-middle border-r border-dashed border-ink/15">
                  <time
                    datetime={post.data.date_published?.toISOString() ?? new Date().toISOString()}
                    class="text-sm font-sans text-ink-light/60 tabular-nums whitespace-nowrap"
                  >
                    {post.data.date_published ? formatDate(post.data.date_published) : "Draft"}
                  </time>
                </td>
                <td class="py-1.5 pl-4 align-middle">
                  <a
                    href={`/${post.data.slug}/`}
                    class="text-ink group-hover:text-accent transition-colors duration-150"
                  >
                    {post.data.title}
                  </a>
                </td>
              </tr>
            ))}
          </>
        ))}
      </tbody>
    </table>
  </div>
</BaseLayout>
