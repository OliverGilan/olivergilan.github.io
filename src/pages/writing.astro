---
import { getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";

const posts = await getCollection("blog", ({ data }) => 
  import.meta.env.DEV || !!data.date_published
);

// Sort by date descending
const sortedPosts = posts.sort(
  (a, b) => new Date(b.data.date_published ?? new Date()).getTime() - new Date(a.data.date_published ?? new Date()).getTime()
);

// Group by year
const postsByYear = sortedPosts.reduce(
  (acc, post) => {
    const year = new Date(post.data.date_published ?? new Date()).getFullYear();
    if (!acc[year]) acc[year] = [];
    acc[year].push(post);
    return acc;
  },
  {} as Record<number, typeof sortedPosts>
);

const years = Object.keys(postsByYear)
  .map(Number)
  .sort((a, b) => b - a);

const categories = ["All", "Lore", "Technical", "Playlists", "Photos"];
const categoryIcons: Record<string, string> = {
  All: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ICON_CLASS"><path d="M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83z" /><path d="M2 12a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 12" /><path d="M2 17a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 17" /></svg>`,
  Lore: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ICON_CLASS"><path d="M12 7v14" /><path d="M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z" /></svg>`,
  Technical: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ICON_CLASS"><path d="m16 18 6-6-6-6" /><path d="m8 6-6 6 6 6" /></svg>`,
  Playlists: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ICON_CLASS"><path d="M9 18V5l12-2v13" /><circle cx="6" cy="18" r="3" /><circle cx="18" cy="16" r="3" /></svg>`,
  Photos: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ICON_CLASS"><rect width="18" height="18" x="3" y="3" rx="2" ry="2" /><circle cx="9" cy="9" r="2" /><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" /></svg>`,
};

const getCategoryIcon = (category: string, className: string) => {
  const svg = categoryIcons[category] ?? categoryIcons.All;
  return svg.replace("ICON_CLASS", className);
};

const formatDate = (date: Date) => {
  return date.toLocaleDateString("en-US", { month: "short", day: "numeric" });
};
---

<BaseLayout title="Writing" description="Thoughts and essays on software, startups, and life.">
  <div class="not-prose">
    <div class="mb-6 flex flex-wrap items-center gap-3 text-[11px] font-sans uppercase tracking-[0.25em] sm:justify-end">
      {categories.map((category) => (
        <button
          type="button"
          data-filter={category}
          aria-pressed={category === "All"}
          class={`relative pb-1 transition-colors after:absolute after:inset-x-0 after:-bottom-px after:h-px after:origin-left after:bg-ink/40 after:transition-transform ${
            category === "All"
              ? "text-accent after:scale-x-100 after:bg-accent"
              : "text-ink/60 after:scale-x-0 hover:text-accent"
          }`}
        >
          <span class="inline-flex items-center gap-2">
            <span
              class="text-ink/50"
              aria-hidden="true"
              set:html={getCategoryIcon(category, "h-3 w-3")}
            />
            <span>{category}</span>
          </span>
        </button>
      ))}
    </div>
    <table class="w-full border-collapse">
      <colgroup>
        <col class="w-24" />
        <col />
      </colgroup>
      {years.map((year, yearIndex) => (
        <tbody data-year={year}>
          {yearIndex > 0 && (
            <tr>
              <td colspan="2" class="h-6"></td>
            </tr>
          )}
          <tr>
            <td colspan="2" class="pb-4">
              <div class="flex items-center gap-4">
                <h2 class="text-sm font-sans font-semibold text-ink-light uppercase tracking-widest">{year}</h2>
                <div class="flex-1 h-px bg-ink/10"></div>
              </div>
            </td>
          </tr>
          {postsByYear[year].map((post) => {
            const category = post.data.tags?.[0] ?? "Technical";
            return (
              <tr class="group" data-category={category}>
                <td class="py-1.5 pr-4 align-middle border-r border-dashed border-ink/15">
                  <div class="flex items-center justify-end gap-2">
                    <time
                      datetime={post.data.date_published?.toISOString() ?? new Date().toISOString()}
                      class="text-sm font-sans text-ink-light/60 tabular-nums whitespace-nowrap"
                    >
                      {post.data.date_published ? formatDate(post.data.date_published) : "Draft"}
                    </time>
                    <span
                      class="text-ink/40"
                      aria-hidden="true"
                      set:html={getCategoryIcon(category, "h-3.5 w-3.5")}
                    />
                  </div>
                </td>
                <td class="py-1.5 pl-4 align-middle">
                  <a
                    href={`/${post.data.slug}/`}
                    class="text-ink group-hover:text-accent transition-colors duration-150"
                  >
                    {post.data.title}
                  </a>
                </td>
              </tr>
            );
          })}
        </tbody>
      ))}
    </table>
  </div>
  <script>
    // @ts-nocheck
    const buttons = Array.from(document.querySelectorAll("[data-filter]"));
    const rows = Array.from(document.querySelectorAll("tr[data-category]"));
    const yearGroups = Array.from(document.querySelectorAll("tbody[data-year]"));
    const activeClasses = ["text-accent", "after:scale-x-100", "after:bg-accent"];
    const inactiveClasses = ["text-ink/60", "after:scale-x-0", "after:bg-ink/40"];

    const setActiveFilter = (filter) => {
      buttons.forEach((button) => {
        const currentFilter = button.getAttribute("data-filter") ?? "All";
        const isActive = currentFilter === filter;
        button.setAttribute("aria-pressed", String(isActive));
        activeClasses.forEach((className) => button.classList.toggle(className, isActive));
        inactiveClasses.forEach((className) => button.classList.toggle(className, !isActive));
      });
    };

    const applyFilter = (filter) => {
      rows.forEach((row) => {
        const category = row.getAttribute("data-category") ?? "";
        const match = filter === "All" || category === filter;
        row.toggleAttribute("hidden", !match);
      });

      yearGroups.forEach((group) => {
        const visibleRows = group.querySelectorAll("tr[data-category]:not([hidden])");
        group.toggleAttribute("hidden", visibleRows.length === 0);
      });
    };

    setActiveFilter("All");
    applyFilter("All");

    buttons.forEach((button) => {
      button.addEventListener("click", () => {
        const filter = button.getAttribute("data-filter") ?? "All";
        setActiveFilter(filter);
        applyFilter(filter);
      });
    });
  </script>
</BaseLayout>
